<!-- ===================================================================== -->
<!-- Custom targets called from a project's generated build.xml            -->
<!-- Set customBuildCallbacks=<path/to/this/file> in your build.properties.-->
<!-- ===================================================================== -->
<project name="eu.geclipse.core.test" default="noDefault">
	
	<target name="noDefault">
		<echo message="This file must be called with explicit targets" />
	</target>
	
	<!-- Special chars which cannot be entered in messages directly -->
    <property name="q" value='"' />
    <property name="lt" value="&lt;" />
    <property name="gt" value="&gt;" />
	
	<!-- A simplified version of the ant-contrib 'foreach' task  -->
	<taskdef name="foreach"
			 classname="eu.geclipse.releng.tools.ForeachTask"
			 classpath="${basedir}/../eu.geclipse.releng/lib/eu.geclipse.releng.tools.jar"
	/>
	
	<!-- All the test classes -->
	<fileset dir="."
			id="allTestClassFiles">
		<include name="**/*_Test.java" />
		<include name="**/*_PDETest.java" />
	</fileset>
	<sort id="sortedTestClassFiles"
			xmlns:rcmp="antlib:org.apache.tools.ant.types.resources.comparators">
		<fileset refid="allTestClassFiles" />
		<rcmp:name />
	</sort>
	<pathconvert pathsep="," property="sortedTestClasses" refid="sortedTestClassFiles">
		<mapper type="regexp" from="^(.*)/([^/]*).java$$" to="\2"/>
	</pathconvert>

	<!-- Run the test in a given plugin -->
	<target name="appendTestClass">
		<echo file="${build.result.folder}/tests.xml" append="true">
          ${lt}ant target=${q}core-test${q} antfile=${q}$${library-file}${q} dir=${q}$${output-dir}${q} ${gt}
            ${lt}property name=${q}classname${q} value=${q}${testClass}${q} /${gt}
          ${lt}/ant${gt}
		</echo>
	</target>
	
	
	<!-- ===================================================================== -->
	<!-- Steps to do before the target build.sources                           -->
	<!-- Available parameters :                                                -->
	<!--   build.result.folder - folder to contain the build results           -->
	<!-- ===================================================================== -->
	<target name="pre.build.sources" depends="pre.clean">
		<echo message="Building tests.xml..." />
		
		<echo file="${build.result.folder}/tests.xml" append="false"
			message="${lt}project name=${q}testsuite${q}${gt}${line.separator}
				${lt}target name=${q}suite${q}${gt}${line.separator}"
		/>
		
		<!-- Iterate over all test classes -->
		<foreach list="${sortedTestClasses}"
				 param="testClass"
				 target="appendTestClass"
				 inheritAll="true"
		/>
		
		<echo file="${build.result.folder}/tests.xml" append="true"
			message="${line.separator}
					 ${lt}/target${gt}${line.separator}
				${lt}/project${gt}${line.separator}"
		/>
		
	</target>

	<target name="post.build.sources" />
	<target name="pre.build.jars" />
	<target name="post.build.jars" />
	<target name="pre.@dot" />
	<target name="post.compile.@dot" />
	<target name="post.@dot" />
	<target name="pre.gather.bin.parts" />
	<target name="post.gather.bin.parts" />
	<target name="pre.gather.sources" />
	<target name="post.gather.sources" />
	<target name="pre.gather.logs" />
	<target name="post.gather.logs" />

	<!-- ===================================================================== -->
	<!-- Steps to do before the target clean                                   -->
	<!-- Available parameters :                                                -->
	<!--   destination.temp.folder - destination folder                        -->
	<!-- ===================================================================== -->
	<target name="pre.clean">
		<delete file="${destination.temp.folder}/tests.xml" />
	</target>

	<target name="post.clean" />
</project>
